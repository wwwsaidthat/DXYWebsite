<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Markdown 文档展示 - 我的个人博客</title>
<link rel="stylesheet" href="styles.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<header class="site-header">
<div class="container header-inner">
<div class="logo">我的博客</div>
<nav class="nav">
<a href="index.html" class="nav-link">首页</a>
<a href="posts.html" class="nav-link">文章</a>
<a href="about.html" class="nav-link">关于</a>
</nav>
</div>
</header>
<main class="site-main">
<section class="section">
<div class="container">
<article class="post-detail">
<h1 class="post-title">Markdown 文档展示</h1>
<div class="post-meta" id="markdown-file-name"></div>
<div class="post-content" id="markdown-content"></div>
</article>
<a href="posts.html" class="button secondary">返回文章列表</a>
</div>
</section>
</main>
<footer class="site-footer">
<div class="container footer-inner">
<span>© <span id="year"></span> 我的个人博客</span>
<span>Powered by GitHub Pages</span>
</div>
</footer>
<script>
document.getElementById("year").textContent = new Date().getFullYear();
function getMarkdownFileFromQuery() {
  var params = new URLSearchParams(window.location.search);
  return params.get("file");
}
function showMessage(message) {
  var container = document.getElementById("markdown-content");
  container.textContent = message;
}
function initMarkdownViewer() {
  var file = getMarkdownFileFromQuery();
  var nameEl = document.getElementById("markdown-file-name");
  if (!file) {
    nameEl.textContent = "未指定文件";
    showMessage("请在链接后添加 ?file=posts/文件名.md 来指定要展示的 Markdown 文件，例如：markdown-viewer.html?file=posts/example.md");
    return;
  }
  nameEl.textContent = file;
  showMessage("正在加载文档...");
  fetch(file).then(function(response) {
    if (!response.ok) {
      throw new Error("加载失败");
    }
    return response.text();
  }).then(function(text) {
    // 获取当前 Markdown 文件所在的目录路径
    var lastSlashIndex = file.lastIndexOf('/');
    var baseDir = lastSlashIndex !== -1 ? file.substring(0, lastSlashIndex + 1) : '';

    // 配置 marked 解析器以支持相对路径图片
    var renderer = new marked.Renderer();
    var originalImage = renderer.image;
    renderer.image = function(href, title, text) {
      // 如果不是绝对路径（http开头、/开头）且不是 data URI，则加上 baseDir
      if (href && !href.startsWith('http') && !href.startsWith('https') && !href.startsWith('/') && !href.startsWith('data:')) {
        href = baseDir + href;
      }
      // 保持原有的 title 和 text 逻辑（虽然这里直接调用 originalImage 可能在某些版本不可行，不如直接返回 img 标签）
      // 为了兼容性，我们简单构造 img 标签
      var out = '<img src="' + href + '" alt="' + text + '"';
      if (title) {
        out += ' title="' + title + '"';
      }
      out += '>';
      return out;
    };

    var container = document.getElementById("markdown-content");
    container.innerHTML = marked.parse(text, { renderer: renderer });
  }).catch(function() {
    showMessage("加载文档失败，请检查文件路径是否正确，以及文件是否已经上传到仓库。");
  });
}
initMarkdownViewer();
</script>
</body>
</html>

